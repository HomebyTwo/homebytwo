{% extends "base.html" %}
{% load leaflet_tags geojson_tags %}

{% block title %}Home by Two - Edit {{ route.name }}{% endblock %}

{% block extralinks %}
  {% leaflet_js %}
  {% leaflet_css %}
{% endblock extralinks %}

{% block content %}
<h2 class="text-center">{{ route.name }}</h2>
<form action="" method="post" enctype="multipart/form-data">{% csrf_token %}
  {# form fields #}
  {% include "_kanbasu_form.html" with form=form %}

  {# map #}
  {% if route.geom %}
  <div class="mrgt grid grid--right">
    <div class="field-label grid__item md-w-1/5">Route Map</div>
    <div class="grid__item md-w-4/5">{% leaflet_map "main" callback="route_map_init" %}</div>
  </div>
  {% endif %}
  {# buttons #}
  <div class="form-group grid grid--right">
    <div class="grid__item md-w-4/5 grid grid--tight">
      {% if route.pk %}
      <a href="{% url 'routes:route' route.pk %}" class="btn btn--default btn--block mrgt-">Cancel</a>
      {% endif %}
      <input class="btn btn--primary btn--block mrgt-" type="submit" value="Save {{ route.name }}" />
    </div>
    <div class="grid__item md-w-4/5">
      {% if route.pk %}
      <a href="{% url 'routes:delete' route.pk %}" class="btn btn--delete btn--block mrgt-">Delete {{ route.name }}</a>
      {% endif %}
    </div>
  </div>
</form>

{% endblock content %}

{% if route.geom %}
  {% block extrajs %}
    <script type="text/javascript">
      function route_map_init (map, options) {
        const route = L.geoJson({{ route|geojsonfeature|safe }});
        route.addTo(map);
        map.fitBounds(route.getBounds());
        map.scrollWheelZoom.disable();
        map.touchZoom.disable();
        map.boxZoom.disable();
        const icon = L.divIcon({
          className: 'placeIcon placeIcon--default',
        });
        const checkpoints = Array.from(document.querySelectorAll('[data-geom]'));
        const markers = checkpoints.map(checkpoint => {
          L.geoJson(JSON.parse(checkpoint.dataset.geom), {
            pointToLayer: (feature, latlng) => L.marker(latlng, {
              icon: icon,
              title: feature.properties.name
            }),
            style: feature => ({color: '000000'}),
            onEachFeature: (feature, layer) => layer.bindPopup(feature.properties.name)
          }).addTo(map);
        });
      }
    </script>
  {% endblock extrajs %}
{% endif %}
